<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spell & Learn</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;overflow:hidden;font-family:Arial,sans-serif;background:#cfe9ff}
canvas{display:block;touch-action:none}
.topbar{
  position:fixed;top:0;left:0;right:0;height:80px;
  background:#ffffffee;display:flex;align-items:center;
  justify-content:space-between;padding:0 12px;z-index:10
}
.btn{
  background:#4caf50;color:#fff;border:none;
  border-radius:14px;padding:10px 14px;font-size:16px
}
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:flex;align-items:center;justify-content:center;z-index:20
}
.card{
  background:#fff;border-radius:24px;
  padding:26px;width:85%;max-width:360px;text-align:center
}
</style>
</head>

<body>

<div class="topbar">
  <div style="font-size:20px">‚≠ê <span id="stars">0</span></div>
  <button class="btn" onclick="resetGame()">üîÑ Reset</button>
</div>

<canvas id="c"></canvas>

<!-- INSTRUCTION -->
<div class="overlay" id="instruction">
  <div class="card">
    <div style="font-size:52px">üê±</div>
    <p style="font-size:20px;line-height:1.5">
      Move the cat or tap the letter bubble to spell the word
    </p>
    <button class="btn" onclick="instruction.style.display='none'">OK</button>
  </div>
</div>

<!-- WORD COMPLETE -->
<div class="overlay" id="popup" style="display:none">
  <div class="card">
    <div id="popupEmoji" style="font-size:96px">üéâ</div>
    <div id="popupWord" style="font-size:36px;font-weight:bold;margin:10px"></div>
    <button class="btn" id="popupBtn">OK</button>
  </div>
</div>

<script>
/* ================= SETUP ================= */
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();addEventListener("resize",resize);

const bg=new Image();bg.src="bg.png";

/* ================= DATA ================= */
const words=["CAT","DOG","COW","PIG","HEN","DUCK","GOAT","LION","BEAR","APPLE","CAR","BUS","SUN","MOON","STAR"];
const emojis={CAT:"üê±",DOG:"üê∂",COW:"üêÑ",PIG:"üê∑",HEN:"üêî",DUCK:"ü¶Ü",
GOAT:"üêê",LION:"ü¶Å",BEAR:"üêª",APPLE:"üçé",CAR:"üöó",BUS:"üöå",SUN:"‚òÄÔ∏è",MOON:"üåô",STAR:"‚≠ê"};

const STORE="spellLearnStableV2";

/* ================= STATE ================= */
let wordIndex=0,letterIndex=0,stars=0;
let collecting=false;
let collisionEnabled=true;

const player={x:200,y:300};
const letter={x:100,y:200,char:"",vx:.6,vy:.5,float:0};

/* ================= STORAGE ================= */
function save(){
  localStorage.setItem(STORE,JSON.stringify({wordIndex,letterIndex,stars}));
}
function load(){
  try{
    const d=JSON.parse(localStorage.getItem(STORE));
    if(!d)return;
    wordIndex=d.wordIndex||0;
    letterIndex=d.letterIndex||0;
    stars=d.stars||0;
  }catch{}
}
load();
document.getElementById("stars").textContent=stars;

/* ================= SPEECH ================= */
function speak(text){
  if(!speechSynthesis)return;
  speechSynthesis.cancel();
  const u=new SpeechSynthesisUtterance(text);
  u.rate=.6;
  speechSynthesis.speak(u);
}

/* ================= RESET ================= */
function resetGame(){
  localStorage.removeItem(STORE);
  location.reload();
}

/* ================= INPUT ================= */
canvas.addEventListener("touchmove",e=>{
  const r=canvas.getBoundingClientRect();
  player.x=e.touches[0].clientX-r.left-60;
  player.y=e.touches[0].clientY-r.top-60;
  e.preventDefault();
});
canvas.addEventListener("click",e=>{
  if(!collisionEnabled) return;
  const dx=e.clientX-(letter.x+60);
  const dy=e.clientY-(letter.y+60);
  if(Math.hypot(dx,dy)<60) collect();
});

/* ================= SAFE SPAWN ================= */
function spawn(){
  collecting=false;
  collisionEnabled=false;

  letter.char=words[wordIndex][letterIndex];

  let safe=false;
  while(!safe){
    letter.x=Math.random()*(canvas.width-140)+40;
    letter.y=Math.random()*(canvas.height-260)+120;

    const dx=(player.x)-(letter.x+60);
    const dy=(player.y)-(letter.y+60);
    safe=Math.hypot(dx,dy)>180; // minimum safe distance
  }

  setTimeout(()=>collisionEnabled=true,300);
}
spawn();

/* ================= COLLECT ================= */
function collect(){
  if(collecting || !collisionEnabled) return;
  collecting=true;
  collisionEnabled=false;

  // Speak LETTER
  speak(letter.char);
  stars++;
  document.getElementById("stars").textContent=stars;
  letterIndex++;
  save();

  if(letterIndex < words[wordIndex].length){
    setTimeout(spawn,300);
  }else{
    // Speak WORD after letter finishes
    setTimeout(()=>{
      speak(words[wordIndex]);
    },700);

    setTimeout(()=>{
      popupEmoji.textContent=emojis[words[wordIndex]]||"üéâ";
      popupWord.textContent=words[wordIndex];
      popup.style.display="flex";
    },1200);
  }
}

popupBtn.onclick=()=>{
  popup.style.display="none";
  wordIndex=(wordIndex+1)%words.length;
  letterIndex=0;
  spawn();
  save();
};

/* ================= DRAW ================= */
function draw(){
  bg.complete?ctx.drawImage(bg,0,0,canvas.width,canvas.height):
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Progress
  ctx.fillStyle="#fff";
  ctx.font="28px Arial";
  ctx.textAlign="center";
  let line="";
  for(let i=0;i<words[wordIndex].length;i++){
    line+=i<letterIndex?words[wordIndex][i]+" ":"‚Ä¢ ";
  }
  ctx.fillText(line.trim(),canvas.width/2,110);

  // Letter
  letter.float+=.03;
  letter.x+=letter.vx;
  letter.y+=letter.vy+Math.sin(letter.float)*.3;
  if(letter.x<0||letter.x>canvas.width-120)letter.vx*=-1;
  if(letter.y<120||letter.y>canvas.height-120)letter.vy*=-1;

  ctx.beginPath();
  ctx.arc(letter.x+60,letter.y+60,55,0,Math.PI*2);
  ctx.fillStyle="#ff7043";
  ctx.fill();

  ctx.fillStyle="#fff";
  ctx.font="bold 72px Arial";
  ctx.fillText(letter.char,letter.x+60,letter.y+78);

  // Cat
  ctx.font="72px Arial";
  ctx.fillText("üê±",player.x,player.y);

  // Collision (only when enabled)
  if(collisionEnabled){
    const dx=(player.x)-(letter.x+60);
    const dy=(player.y)-(letter.y+60);
    if(Math.hypot(dx,dy)<90) collect();
  }

  requestAnimationFrame(draw);
}
draw();
</script>

</body>
</html>
